(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{326:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mongodb-聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-聚合"}},[s._v("#")]),s._v(" MongoDB 聚合")]),s._v(" "),a("p",[a("RouterLink",{attrs:{to:"/data-base/mongodb/"}},[s._v("目录")])],1),s._v(" "),a("blockquote",[a("p",[s._v("MongoDB中聚合"),a("code",[s._v("(aggregate)")]),s._v("主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似sql语句中的 "),a("code",[s._v("count(*)")]),s._v("。")])]),s._v(" "),a("h4",{attrs:{id:"aggregate-方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aggregate-方法"}},[s._v("#")]),s._v(" aggregate() 方法")]),s._v(" "),a("p",[s._v("语法")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("COLLECTION_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("AGGREGATE_OPERATION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("实例")]),s._v(" "),a("p",[s._v("集合中的数据如下：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("{\n   _id: ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("df78ad8902c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   title: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MongoDB Overview'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'MongoDB is no sql database'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   by_user: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'runoob.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   url: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://www.runoob.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   tags: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mongodb'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'database'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'NoSQL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   likes: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n{\n   _id: ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("df78ad8902d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   title: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'NoSQL Overview'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'No sql database is very fast'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   by_user: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'runoob.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   url: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://www.runoob.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   tags: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mongodb'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'database'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'NoSQL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   likes: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n{\n   _id: ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("df78ad8902e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   title: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Neo4j Overview'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Neo4j is no sql database'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   by_user: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Neo4j'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   url: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://www.neo4j.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   tags: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'neo4j'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'database'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'NoSQL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   likes: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("750")]),s._v("\n}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[s._v("通过以上集合计算每个作者所写的文章数，使用aggregate()计算结果如下：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mycol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("{$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" : {_id : "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$by_user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" num_tutorial : {$sum : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("}}}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n{\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"result"')]),s._v(" : "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      {\n         "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" : "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runoob.com"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"num_tutorial"')]),s._v(" : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n      }"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      {\n         "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" : "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Neo4j"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"num_tutorial"')]),s._v(" : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n      }\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("以上实例类似sql语句： "),a("code",[s._v("select by_user, count(*) from mycol group by by_user")])]),s._v(" "),a("p",[s._v("在上面的例子中，我们通过字段"),a("code",[s._v("by_user")]),s._v("字段对数据进行分组，并计算"),a("code",[s._v("by_user")]),s._v("字段相同值的总和。")]),s._v(" "),a("p",[s._v("下表展示了一些聚合的表达式:")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("表达式")]),s._v(" "),a("th",[s._v("描述")]),s._v(" "),a("th",[s._v("实例")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[a("code",[s._v("$sum")])]),s._v(" "),a("td",[s._v("计算总和。")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$sum : "$likes"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$avg")])]),s._v(" "),a("td",[s._v("计算平均值")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$avg : "$likes"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$min")])]),s._v(" "),a("td",[s._v("获取集合中所有文档对应值得最小值。")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$min : "$likes"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$max")])]),s._v(" "),a("td",[s._v("获取集合中所有文档对应值得最大值。")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$max : "$likes"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$push")])]),s._v(" "),a("td",[s._v("在结果文档中插入值到一个数组中。")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", url : {$push: "$url"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$addToSet")])]),s._v(" "),a("td",[s._v("在结果文档中插入值到一个数组中，但不创建副本。")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", url : {$addToSet : "$url"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$first")])]),s._v(" "),a("td",[s._v("根据资源文档的排序获取第一个文档数据。")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", first_url : {$first : "$url"}}}])')])])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("$last")])]),s._v(" "),a("td",[s._v("根据资源文档的排序获取最后一个文档数据")]),s._v(" "),a("td",[a("code",[s._v('db.mycol.aggregate([{$group : {_id : "$by_user", last_url : {$last : "$url"}}}])')])])])])]),s._v(" "),a("h4",{attrs:{id:"管道的概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管道的概念"}},[s._v("#")]),s._v(" 管道的概念")]),s._v(" "),a("blockquote",[a("p",[s._v("管道在"),a("code",[s._v("Unix")]),s._v("和"),a("code",[s._v("Linux")]),s._v("中一般用于将当前命令的输出结果作为下一个命令的参数。")])]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("MongoDB")]),s._v("的聚合管道将"),a("code",[s._v("MongoDB")]),s._v("文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的。")])]),s._v(" "),a("blockquote",[a("p",[s._v("表达式：处理输入文档并输出。表达式是无状态的，只能用于计算当前聚合管道的文档，不能处理其它的文档。")])]),s._v(" "),a("p",[s._v("这里我们介绍一下聚合框架中常用的几个操作：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("$project：")]),s._v(" 修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。")]),s._v(" "),a("li",[a("strong",[s._v("$match：")]),s._v(" 用于过滤数据，只输出符合条件的文档。"),a("code",[s._v("$match")]),s._v("使用"),a("code",[s._v("MongoDB")]),s._v("的标准查询操作。")]),s._v(" "),a("li",[a("strong",[s._v("$limit：")]),s._v(" 用来限制"),a("code",[s._v("MongoDB")]),s._v("聚合管道返回的文档数。")]),s._v(" "),a("li",[a("strong",[s._v("$skip：")]),s._v(" 在聚合管道中跳过指定数量的文档，并返回余下的文档。")]),s._v(" "),a("li",[a("strong",[s._v("$unwind：")]),s._v(" 将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。")]),s._v(" "),a("li",[a("strong",[s._v("$group：")]),s._v(" 将集合中的文档分组，可用于统计结果。")]),s._v(" "),a("li",[a("strong",[s._v("$sort：")]),s._v(" 将输入文档排序后输出。")]),s._v(" "),a("li",[a("strong",[s._v("$geoNear：")]),s._v(" 输出接近某一地理位置的有序文档。")])]),s._v(" "),a("p",[a("strong",[s._v("管道操作符实例")])]),s._v(" "),a("p",[s._v("1、"),a("code",[s._v("$project")]),s._v("实例")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("article"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    { $project : {\n        title : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        author : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    }}\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这样的话结果中就只还有"),a("code",[s._v("_id")]),s._v(","),a("code",[s._v("tilte")]),s._v("和"),a("code",[s._v("author")]),s._v("三个字段了，默认情况下"),a("code",[s._v("_id")]),s._v("字段是被包含的，如果要想不包含"),a("code",[s._v("_id")]),s._v("话可以这样:")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("article"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    { $project : {\n        _id : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        title : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        author : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    }}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("2、"),a("code",[s._v("$match")]),s._v("实例")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("articles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                        { $"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("match")]),s._v(" : { score : { $gt : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" $lte : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v(" } } }"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        { $"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(": { _id: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" count: { $sum: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" } } }\n                       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("code",[s._v("$match")]),s._v("用于获取分数大于70小于或等于90记录，然后将符合条件的记录送到下一阶段"),a("code",[s._v("$group")]),s._v("管道操作符进行处理。")]),s._v(" "),a("p",[s._v("3、"),a("code",[s._v("$skip")]),s._v("实例")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("article"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{ $skip : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" }"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("经过"),a("code",[s._v("$skip")]),s._v('管道操作符处理后，前五个文档被"过滤"掉。')]),s._v(" "),a("p",[a("strong",[s._v("笔记：")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mycol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("{$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" : {_id : "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$by_user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" num_tutorial : {$sum : "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("}}}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("以上实例类似sql语句：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" by_user "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" _id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" num_tutorial "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mycol "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" by_user\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("articles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{\n    $project : {\n        title: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        by_user: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    }\n}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这样子也是可行的。也就是说非0也可以进行表示显示该字段,负数也可以表示显示该字段。")]),s._v(" "),a("p",[s._v("按日、按月、按年、按周、按小时、按分钟聚合操作如下：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getCollection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'m_msg_tb'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aggregate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    {$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("match")]),s._v(":{m_id:"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mark_time:{$gt:new "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("}}}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    {$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(": {\n       _id: {$dayOfMonth:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$mark_time'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        pv: {$sum: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("}\n        }\n    }"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    {$sort: {"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("}}\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("时间关键字如下：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("$dayOfYear:")]),s._v(" 返回该日期是这一年的第几天（全年 366 天）。")]),s._v(" "),a("li",[a("strong",[s._v("$dayOfMonth:")]),s._v(" 返回该日期是这一个月的第几天（1到31）。")]),s._v(" "),a("li",[a("strong",[s._v("$dayOfWeek:")]),s._v(" 返回的是这个周的星期几（1：星期日，7：星期六）。")]),s._v(" "),a("li",[a("strong",[s._v("$year:")]),s._v(" 返回该日期的年份部分。")]),s._v(" "),a("li",[a("strong",[s._v("$month:")]),s._v("  返回该日期的月份部分（ 1 到 12）。")]),s._v(" "),a("li",[a("strong",[s._v("$week:")]),s._v("  返回该日期是所在年的第几个星期（ 0 到 53）。")]),s._v(" "),a("li",[a("strong",[s._v("$hour:")]),s._v("  返回该日期的小时部分。")]),s._v(" "),a("li",[a("strong",[s._v("$minute:")]),s._v(" 返回该日期的分钟部分。")]),s._v(" "),a("li",[a("strong",[s._v("$second:")]),s._v(" 返回该日期的秒部分（以0到59之间的数字形式返回日期的第二部分，但可以是60来计算闰秒）。")]),s._v(" "),a("li",[a("strong",[s._v("$millisecond:")]),s._v(" 返回该日期的毫秒部分（ 0 到 999）。")]),s._v(" "),a("li",[a("strong",[s._v("$dateToString:")]),s._v("  { $dateToString: { format: , date: } }。")])]),s._v(" "),a("p",[a("a",{staticStyle:{float:"right"},attrs:{href:"replication.md"}},[s._v("MongoDB 复制（副本集）")])])])}),[],!1,null,null,null);t.default=e.exports}}]);