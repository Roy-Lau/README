(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{344:function(s,t,a){"use strict";a.r(t);var n=a(1),r=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mongodb-分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-分片"}},[s._v("#")]),s._v(" MongoDB 分片")]),s._v(" "),a("p",[a("RouterLink",{attrs:{to:"/data-base/mongodb/"}},[s._v("目录")])],1),s._v(" "),a("p",[a("strong",[s._v("分片")])]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("Mongodb")]),s._v("里面存在另一种集群，就是分片技术,可以满足"),a("code",[s._v("MongoDB")]),s._v("数据量大量增长的需求。")]),s._v(" "),a("p",[s._v("当"),a("code",[s._v("MongoDB")]),s._v("存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据。")]),s._v(" "),a("p",[a("strong",[s._v("为什么使用分片?")])]),s._v(" "),a("ul",[a("li",[s._v("复制所有的写入操作到主节点")]),s._v(" "),a("li",[s._v("延迟的敏感数据会在主节点查询")]),s._v(" "),a("li",[s._v("单个副本集限制在12个节点")]),s._v(" "),a("li",[s._v("当请求量巨大时会出现内存不足。")]),s._v(" "),a("li",[s._v("本地磁盘不足")]),s._v(" "),a("li",[s._v("垂直扩展价格昂贵")])]),s._v(" "),a("h4",{attrs:{id:"mongodb分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb分片"}},[s._v("#")]),s._v(" MongoDB分片")]),s._v(" "),a("p",[s._v("下图展示了在MongoDB中使用分片集群结构分布：")]),s._v(" "),a("img",{attrs:{src:"imgs/sharding.png",alt:"MongoDB分片图"}}),s._v(" "),a("p",[s._v("上图中主要有如下所述三个主要组件：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Shard:")]),s._v(" 用于存储实际的数据块，实际生产环境中一个"),a("code",[s._v("shard server")]),s._v("角色可由几台机器组个一个"),a("code",[s._v("replica set")]),s._v("承担，防止主机单点故障")]),s._v(" "),a("li",[a("strong",[s._v("Config Server:")]),s._v(" "),a("code",[s._v("mongod")]),s._v("实例，存储了整个 "),a("code",[s._v("ClusterMetadata")]),s._v("，其中包括 "),a("code",[s._v("chunk")]),s._v("信息。")]),s._v(" "),a("li",[a("strong",[s._v("Query Routers:")]),s._v("    前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。")])]),s._v(" "),a("p",[a("strong",[s._v("分片实例")])]),s._v(" "),a("p",[s._v("分片结构端口分布如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Shard Server 1：27020\nShard Server 2：27021\nShard Server 3：27022\nShard Server 4：27023\nConfig Server ：27100\nRoute Process：40000\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("步骤一：启动"),a("code",[s._v("Shard Server")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /www/mongoDB/shard/s0\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /www/mongoDB/shard/s1\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /www/mongoDB/shard/s2\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /www/mongoDB/shard/s3\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /www/mongoDB/shard/log\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" /usr/local/mongoDB/bin/mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27020")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/s0 --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/log/s0.log --logappend --fork\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" /usr/local/mongoDB/bin/mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27023")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/s3 --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/log/s3.log --logappend --fork\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("步骤二： 启动"),a("code",[s._v("Config Server")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /www/mongoDB/shard/config\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" /usr/local/mongoDB/bin/mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27100")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/config --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/log/config.log --logappend --fork\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("注意：")]),s._v(" 这里我们完全可以像启动普通"),a("code",[s._v("mongodb")]),s._v("服务一样启动，不需要添加"),a("code",[s._v("—shardsvr")]),s._v("和"),a("code",[s._v("configsvr")]),s._v("参数。因为这两个参数的作用就是改变启动端口的，所以我们自行指定了端口就可以。")]),s._v(" "),a("p",[s._v("步骤三： 启动"),a("code",[s._v("Route Process")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("/usr/local/mongoDB/bin/mongos --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),s._v(" --configdb localhost:27100 --fork --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/www/mongoDB/shard/log/route.log --chunkSize "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("mongos")]),s._v("启动参数中，"),a("code",[s._v("chunkSize")]),s._v("这一项是用来指定"),a("code",[s._v("chunk")]),s._v("的大小的，单位是"),a("code",[s._v("MB")]),s._v("，默认大小为"),a("code",[s._v("200MB")]),s._v(".")]),s._v(" "),a("p",[s._v("步骤四： 配置"),a("code",[s._v("Sharding")])]),s._v(" "),a("p",[s._v("接下来，我们使用"),a("code",[s._v("MongoDB Shell")]),s._v("登录到"),a("code",[s._v("mongos")]),s._v("，添加"),a("code",[s._v("Shard")]),s._v("节点")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@100 shard"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" /usr/local/mongoDB/bin/mongo admin --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),s._v("\nMongoDB shell version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.0")]),s._v(".7\nconnecting to: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:40000/admin\nmongos"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" addshard:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:27020"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shardAdded"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard0000"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nmongos"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" addshard:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:27029"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shardAdded"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard0009"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nmongos"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" enablesharding:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置分片存储的数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nmongos"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" shardcollection: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test.log"')]),s._v(", key: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" id:1,time:1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"collectionsharded"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test.log"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("步骤五： 程序代码内无需太大更改，直接按照连接普通的"),a("code",[s._v("mongo")]),s._v("数据库那样，将数据库连接接入接口"),a("code",[s._v("40000")])]),s._v(" "),a("p",[a("strong",[s._v("笔记")])]),s._v(" "),a("ol",[a("li",[s._v("创建"),a("code",[s._v("Sharding")]),s._v("复制集 "),a("code",[s._v("rs0")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/db1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27020")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/db1 --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/log/rs0-1.log --logappend --fork --shardsvr --replSet"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rs0 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/db2\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27021")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/db2 --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/log/rs0-2.log --logappend --fork --shardsvr --replSet"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rs0 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("1.1 复制集rs0配置")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongo localhost:27020")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("initiate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{_id: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rs0'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" members: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("{_id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:27020'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" {_id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:27021'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("isMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看主从关系")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建Sharding复制集 rs1")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/db3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27030")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/db3 --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/log/rs1-1.log --logappend --fork --shardsvr --replSet"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rs1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/db4\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" mongod --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27031")]),s._v(" --dbpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/db4 --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/log/rs1-2.log --logappend --fork --shardsvr --replSet"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rs1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("2.1 复制集rs1配置")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongo localhost:27030")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("initiate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{_id: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rs1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" members: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("{_id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:27030'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" {_id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:27031'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("isMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看主从关系")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("创建Config复制集 conf")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mkdir "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf1\nnohup mongod "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--port 27100 --dbpath=/data/conf1 --logpath=/data/log/conf-1.log --logappend --fork --configsvr --replSet=conf &")]),s._v("\nmkdir "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf2\nnohup mongod "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--port 27101 --dbpath=/data/conf2 --logpath=/data/log/conf-2.log --logappend --fork --configsvr --replSet=conf &")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("3.1 复制集conf配置")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongo localhost:27100")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("initiate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{_id: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'conf'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" members: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("{_id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:27100'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" {_id: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost:27101'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("isMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看主从关系")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("创建Route")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" mongos --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),s._v(" --configdb conf/localhost:27100,localhost:27101 --fork --logpath"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/log/route.log --logappend "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4.1 设置分片")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongo localhost:40000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" admin\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{ addshard: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rs0/localhost:27020,localhost:27021'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{ addshard: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rs1/localhost:27030,localhost:27031'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{ enablesharding: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),s._v("}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runCommand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("{ shardcollection: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test.user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),s._v(": {name: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("}}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("a",{staticStyle:{float:"right"},attrs:{href:"mongodump-mongorestore.md"}},[s._v("MongoDB 备份(mongodump)与恢复(mongorestore)")])])])}),[],!1,null,null,null);t.default=r.exports}}]);